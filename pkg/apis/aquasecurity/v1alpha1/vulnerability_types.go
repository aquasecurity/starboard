package v1alpha1

import (
	"strconv"

	"github.com/aquasecurity/starboard/pkg/apis/aquasecurity"
	apiextensionsv1 "k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/labels"
	"k8s.io/utils/pointer"
)

const (
	VulnerabilityReportsCRName    = "vulnerabilityreports.aquasecurity.github.io"
	VulnerabilityReportsCRVersion = "v1alpha1"
	VulnerabilityReportKind       = "VulnerabilityReport"
	VulnerabilityReportListKind   = "VulnerabilityReportList"
)

var (
	// TODO Once we migrate to Go 1.16 we can use the embed package to load the CRD from ./deploy/crd/vulnerabilityreports.crd.yaml
	VulnerabilityReportsCRD = apiextensionsv1.CustomResourceDefinition{
		ObjectMeta: metav1.ObjectMeta{
			Name: VulnerabilityReportsCRName,
			Labels: labels.Set{
				"app.kubernetes.io/managed-by": "starboard",
			},
		},
		Spec: apiextensionsv1.CustomResourceDefinitionSpec{
			Group: aquasecurity.GroupName,
			Versions: []apiextensionsv1.CustomResourceDefinitionVersion{
				{
					Name:    VulnerabilityReportsCRVersion,
					Served:  true,
					Storage: true,
					AdditionalPrinterColumns: []apiextensionsv1.CustomResourceColumnDefinition{
						{
							JSONPath: ".report.artifact.repository",
							Type:     "string",
							Name:     "Repository",
						},
						{
							JSONPath: ".report.artifact.tag",
							Type:     "string",
							Name:     "Tag",
						},
						{
							JSONPath: ".report.scanner.name",
							Type:     "string",
							Name:     "Scanner",
						},
						{
							JSONPath: ".metadata.creationTimestamp",
							Type:     "date",
							Name:     "Age",
						},
						{
							JSONPath: ".report.summary.criticalCount",
							Type:     "integer",
							Name:     "Critical",
							Priority: 1,
						},
						{
							JSONPath: ".report.summary.highCount",
							Type:     "integer",
							Name:     "High",
							Priority: 1,
						},
						{
							JSONPath: ".report.summary.mediumCount",
							Type:     "integer",
							Name:     "Medium",
							Priority: 1,
						},
						{
							JSONPath: ".report.summary.lowCount",
							Type:     "integer",
							Name:     "Low",
							Priority: 1,
						},
						{
							JSONPath: ".report.summary.unknownCount",
							Type:     "integer",
							Name:     "Unknown",
							Priority: 1,
						},
					},
					Schema: &apiextensionsv1.CustomResourceValidation{
						OpenAPIV3Schema: &apiextensionsv1.JSONSchemaProps{
							Type: "object",
							Required: []string{
								"apiVersion",
								"kind",
								"metadata",
								"report",
							},
							Properties: map[string]apiextensionsv1.JSONSchemaProps{
								"apiVersion": {Type: "string"},
								"kind":       {Type: "string"},
								"metadata":   {Type: "object"},
								"report": {
									Type: "object",
									Required: []string{
										"scanner",
										"artifact",
										"vulnerabilities",
									},
									Properties: map[string]apiextensionsv1.JSONSchemaProps{
										"scanner": {
											Type: "object",
											Required: []string{
												"name",
												"vendor",
												"version",
											},
											Properties: map[string]apiextensionsv1.JSONSchemaProps{
												"name":    {Type: "string"},
												"vendor":  {Type: "string"},
												"version": {Type: "string"},
											},
										},
										"registry": {
											Type: "object",
											Properties: map[string]apiextensionsv1.JSONSchemaProps{
												"server": {Type: "string"},
											},
										},
										"artifact": {
											Type: "object",
											Properties: map[string]apiextensionsv1.JSONSchemaProps{
												"repository": {Type: "string"},
												"digest":     {Type: "string"},
												"tag":        {Type: "string"},
												"mimeType":   {Type: "string"},
											},
										},
										"summary": {
											Type: "object",
											Required: []string{
												"criticalCount",
												"highCount",
												"mediumCount",
												"lowCount",
												"unknownCount",
											},
											Properties: map[string]apiextensionsv1.JSONSchemaProps{
												"criticalCount": {Type: "integer", Minimum: pointer.Float64Ptr(0)},
												"highCount":     {Type: "integer", Minimum: pointer.Float64Ptr(0)},
												"mediumCount":   {Type: "integer", Minimum: pointer.Float64Ptr(0)},
												"lowCount":      {Type: "integer", Minimum: pointer.Float64Ptr(0)},
												"unknownCount":  {Type: "integer", Minimum: pointer.Float64Ptr(0)},
											},
										},
										"updateTimestamp": {
											Type:   "string",
											Format: "date-time",
										},
										"vulnerabilities": {
											Type: "array",
											Items: &apiextensionsv1.JSONSchemaPropsOrArray{
												Schema: &apiextensionsv1.JSONSchemaProps{
													Type: "object",
													Required: []string{
														"vulnerabilityID",
														"resource",
														"installedVersion",
														"fixedVersion",
														"severity",
														"title",
													},
													Properties: map[string]apiextensionsv1.JSONSchemaProps{
														"vulnerabilityID":  {Type: "string"},
														"resource":         {Type: "string"},
														"installedVersion": {Type: "string"},
														"fixedVersion":     {Type: "string"},
														"severity": {
															Type: "string",
															Enum: []apiextensionsv1.JSON{
																{Raw: []byte(strconv.Quote(string(SeverityCritical)))},
																{Raw: []byte(strconv.Quote(string(SeverityHigh)))},
																{Raw: []byte(strconv.Quote(string(SeverityMedium)))},
																{Raw: []byte(strconv.Quote(string(SeverityLow)))},
																{Raw: []byte(strconv.Quote(string(SeverityUnknown)))},
															},
														},
														"title":       {Type: "string"},
														"description": {Type: "string"},
														"primaryLink": {Type: "string"},
														"links": {
															Type: "array",
															Items: &apiextensionsv1.JSONSchemaPropsOrArray{
																Schema: &apiextensionsv1.JSONSchemaProps{
																	Type: "string",
																},
															},
														},
													},
												},
											},
										},
									},
								},
							},
						},
					},
				},
			},
			Scope: apiextensionsv1.NamespaceScoped,
			Names: apiextensionsv1.CustomResourceDefinitionNames{
				Singular:   "vulnerabilityreport",
				Plural:     "vulnerabilityreports",
				Kind:       VulnerabilityReportKind,
				ListKind:   VulnerabilityReportListKind,
				Categories: []string{"all"},
				ShortNames: []string{"vulns", "vuln"},
			},
		},
	}
)

type Severity string

const (
	SeverityCritical Severity = "CRITICAL"
	SeverityHigh     Severity = "HIGH"
	SeverityMedium   Severity = "MEDIUM"
	SeverityLow      Severity = "LOW"
	SeverityNone     Severity = "NONE"
	SeverityUnknown  Severity = "UNKNOWN"
)

type VulnerabilitySummary struct {
	CriticalCount int `json:"criticalCount"`
	HighCount     int `json:"highCount"`
	MediumCount   int `json:"mediumCount"`
	LowCount      int `json:"lowCount"`
	NoneCount     int `json:"noneCount"`
	UnknownCount  int `json:"unknownCount"`
}

type Registry struct {
	Server string `json:"server"`
}

// Artifact is the spec for an artifact that can be scanned.
type Artifact struct {
	Repository string `json:"repository"`
	Digest     string `json:"digest,omitempty"`
	Tag        string `json:"tag,omitempty"`
	MimeType   string `json:"mimeType,omitempty"`
}

// Vulnerability is the spec for a vulnerability record.
type Vulnerability struct {
	VulnerabilityID  string   `json:"vulnerabilityID"`
	Resource         string   `json:"resource"`
	InstalledVersion string   `json:"installedVersion"`
	FixedVersion     string   `json:"fixedVersion"`
	Severity         Severity `json:"severity"`
	Title            string   `json:"title"`
	Description      string   `json:"description,omitempty"`
	PrimaryLink      string   `json:"primaryLink,omitempty"`
	Links            []string `json:"links"`
}

// +genclient
// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object

// VulnerabilityReport is a specification for the VulnerabilityReport resource.
type VulnerabilityReport struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Report VulnerabilityScanResult `json:"report"`
}

// VulnerabilityScanResult is the spec for the vulnerability scan result.
//
// The spec follows the Pluggable Scanners API defined for Harbor.
// @see https://github.com/goharbor/pluggable-scanner-spec/blob/master/api/spec/scanner-adapter-openapi-v1.0.yaml
type VulnerabilityScanResult struct {
	UpdateTimestamp metav1.Time          `json:"updateTimestamp"`
	Scanner         Scanner              `json:"scanner"`
	Registry        Registry             `json:"registry"`
	Artifact        Artifact             `json:"artifact"`
	Summary         VulnerabilitySummary `json:"summary"`
	Vulnerabilities []Vulnerability      `json:"vulnerabilities"`
}

// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object

// VulnerabilityReportList is a list of VulnerabilityReport resources.
type VulnerabilityReportList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata"`

	Items []VulnerabilityReport `json:"items"`
}
